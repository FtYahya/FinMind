<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>FinMind Sniper – Controlled Quant Edition</title>

<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
body { background:#000; color:#e5e7eb; font-family: monospace; }
</style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">

const { useState, useRef, useEffect } = React;

function App(){

const [ticker,setTicker] = useState("");
const [apiKey,setApiKey] = useState("");
const [capital,setCapital] = useState(100000);
const [status,setStatus] = useState("IDLE");
const [result,setResult] = useState(null);
const [history,setHistory] = useState(JSON.parse(localStorage.getItem("trade_history")) || []);
const [cooldown,setCooldown] = useState(false);

const controllerRef = useRef(null);

useEffect(()=>{
localStorage.setItem("trade_history",JSON.stringify(history));
},[history]);

// MARKET CHECK
function isMarketOpen(){
const now = new Date();
const day = now.getDay();
if(day===0 || day===6) return false;

const hour = now.getHours();
const min = now.getMinutes();

const open = (hour>9 || (hour===9 && min>=15));
const close = (hour<15 || (hour===15 && min<=30));

return open && close;
}

// POSITION SIZE
function positionSize(entry,stop){
const risk = capital * 0.01;
const diff = Math.abs(entry-stop);
if(diff===0) return 0;
return Math.floor(risk/diff);
}

// CONFIDENCE ENGINE
function computeConfidence(d){
let score = 0;
if(d.volumeSpike>150) score+=30;
if(d.rsi>=55 && d.rsi<=70) score+=20;
if(d.breakout) score+=25;
if(d.newsRecent) score+=25;
return score;
}

async function scan(){

if(!apiKey) return alert("Enter API Key");
if(!ticker.match(/^[A-Z]+$/)) return alert("Invalid Ticker");
if(!isMarketOpen()) return alert("Market Closed");
if(cooldown) return alert("Wait 30 seconds before next scan");

setCooldown(true);
setTimeout(()=>setCooldown(false),30000);

if(controllerRef.current) controllerRef.current.abort();
controllerRef.current = new AbortController();

setStatus("SCANNING");

const prompt = `
Return STRICT JSON ONLY.

{
"name":"",
"price":number,
"rsi":number,
"volumeSpike":number,
"breakout":true/false,
"newsRecent":true/false,
"target":number,
"stopLoss":number,
"action":"BUY or SHORT"
}

Stock: ${ticker} NSE
Use latest available information.
`;

try{

const res = await fetch(
`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
{
method:"POST",
headers:{"Content-Type":"application/json"},
signal: controllerRef.current.signal,
body: JSON.stringify({
contents:[{parts:[{text:prompt}]}],
tools:[{google_search:{}}]
})
}
);

const data = await res.json();
const text = data.candidates?.[0]?.content?.parts?.[0]?.text;

if(!text) throw new Error("Empty response");

const parsed = JSON.parse(text);

if(
!parsed.name ||
!parsed.price ||
!parsed.target ||
!parsed.stopLoss ||
!parsed.action
){
throw new Error("Invalid AI structure");
}

const confidence = computeConfidence(parsed);

if(confidence<70){
setResult({error:"Low confidence (<70%)"});
setStatus("IDLE");
return;
}

const qty = positionSize(parsed.price,parsed.stopLoss);

const trade = {
...parsed,
confidence,
quantity: qty,
time: new Date().toLocaleString()
};

setResult(trade);
setHistory([trade,...history]);
setStatus("IDLE");

}catch(e){
setResult({error:e.message});
setStatus("ERROR");
}

}

return(
<div className="p-6 space-y-4 max-w-xl mx-auto">

<h1 className="text-orange-500 text-xl font-bold">
FinMind Sniper – Controlled Quant Edition
</h1>

<input
className="bg-gray-900 p-3 w-full rounded"
placeholder="NSE Ticker (e.g. ADANIENT)"
value={ticker}
onChange={e=>setTicker(e.target.value.toUpperCase())}
/>

<input
type="password"
className="bg-gray-900 p-3 w-full rounded"
placeholder="Gemini API Key"
value={apiKey}
onChange={e=>setApiKey(e.target.value)}
/>

<input
type="number"
className="bg-gray-900 p-3 w-full rounded"
placeholder="Capital"
value={capital}
onChange={e=>setCapital(Number(e.target.value))}
/>

<button
onClick={scan}
disabled={status==="SCANNING"}
className="bg-orange-600 w-full p-3 rounded font-bold"
>
{status==="SCANNING" ? "Scanning..." : "Execute Scan"}
</button>

{result && (
<div className="bg-gray-900 p-4 rounded text-sm">

{result.error ? (
<div className="text-red-500">{result.error}</div>
):(
<div className="space-y-1">
<div>Stock: {result.name}</div>
<div>Price: {result.price}</div>
<div>Action: {result.action}</div>
<div>Target: {result.target}</div>
<div>Stop: {result.stopLoss}</div>
<div>Confidence: {result.confidence}%</div>
<div>Position Size: {result.quantity}</div>
</div>
)}

</div>
)}

{history.length>0 && (
<div className="bg-gray-900 p-4 rounded text-xs">
<div className="text-orange-500 mb-2">Trade History</div>
{history.map((h,i)=>(
<div key={i} className="border-b border-gray-800 py-1">
{h.time} - {h.name} ({h.confidence}%)
</div>
))}
</div>
)}

</div>
);
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);

</script>
</body>
</html>
