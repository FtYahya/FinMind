<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>FinMind iOS</title>
    
    <!-- Libraries -->
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #000000;
            --card: #1c1c1e;
            --accent: #0A84FF;
            --green: #30D158;
            --red: #FF453A;
            --text: #FFFFFF;
            --text-sec: #8E8E93;
            --border: #38383A;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            background-color: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- HEADER --- */
        header {
            padding-top: max(10px, var(--safe-top));
            padding-bottom: 10px;
            padding-left: 20px;
            padding-right: 20px;
            background: rgba(28, 28, 30, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 0.5px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }

        .brand { font-weight: 800; font-size: 1.1rem; letter-spacing: -0.5px; }
        .brand span { color: var(--accent); }
        .live-dot { width: 8px; height: 8px; background: var(--green); border-radius: 50%; box-shadow: 0 0 10px var(--green); }

        /* --- CONTENT --- */
        main {
            flex: 1;
            overflow: hidden;
            position: relative;
            background: var(--bg);
        }

        .view-section {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 20px;
            padding-bottom: 100px;
            display: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .view-section.active {
            display: block;
            opacity: 1;
        }

        /* --- INPUTS --- */
        .input-card {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        label {
            color: var(--text-sec);
            font-size: 0.8rem;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
        }

        input, select {
            width: 100%;
            background: #2C2C2E;
            border: none;
            color: white;
            padding: 14px;
            font-size: 16px;
            border-radius: 10px;
            margin-bottom: 20px;
            appearance: none; /* Remove default styling */
        }

        input:focus { outline: 2px solid var(--accent); }

        .btn-main {
            width: 100%;
            background: var(--accent);
            color: white;
            font-weight: 600;
            font-size: 17px;
            padding: 16px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(10, 132, 255, 0.3);
            transition: transform 0.1s;
        }
        
        .btn-main:active { transform: scale(0.96); opacity: 0.8; }

        .btn-scan {
            background: transparent;
            border: 1px solid var(--accent);
            color: var(--accent);
            margin-top: 15px;
        }

        /* --- CHART --- */
        #chart-view { padding: 0; display: flex; flex-direction: column; }
        
        .chart-header-overlay {
            position: absolute;
            top: 20px; left: 20px;
            z-index: 10;
            pointer-events: none;
        }
        .symbol-title { font-size: 28px; font-weight: 800; margin: 0; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .price-display { font-size: 20px; font-weight: 500; font-family: 'Inter', monospace; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }

        #chart-container { width: 100%; height: 100%; background: black; }

        /* --- REPORT --- */
        .verdict-banner {
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            font-weight: 800;
            font-size: 24px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .v-buy { background: rgba(48, 209, 88, 0.15); color: var(--green); border-color: var(--green); }
        .v-sell { background: rgba(255, 69, 58, 0.15); color: var(--red); border-color: var(--red); }
        .v-wait { background: rgba(255,255,255,0.1); color: #ccc; }

        .ai-text { font-size: 16px; line-height: 1.6; color: #E5E5EA; }
        .ai-text h3 { color: var(--accent); margin-top: 25px; font-size: 18px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .ai-text ul { padding-left: 20px; color: var(--text-sec); }
        .ai-text li { margin-bottom: 10px; }
        .ai-text strong { color: white; }

        /* --- TAB BAR --- */
        .tab-bar {
            background: rgba(28, 28, 30, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 0.5px solid var(--border);
            padding-bottom: max(10px, var(--safe-bottom));
            padding-top: 10px;
            display: flex;
            justify-content: space-around;
            z-index: 100;
        }

        .tab-btn {
            background: none;
            border: none;
            color: var(--text-sec);
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 10px;
            gap: 5px;
            width: 60px;
            cursor: pointer;
        }

        .tab-btn i { font-size: 20px; transition: 0.2s; }
        .tab-btn.active { color: var(--accent); }
        .tab-btn.active i { transform: translateY(-2px); }

        /* --- MODAL --- */
        .loader-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            z-index: 200;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid #333;
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .toast {
            position: fixed; top: 50px; left: 50%; transform: translateX(-50%);
            background: var(--green); color: black; padding: 10px 20px;
            border-radius: 20px; font-weight: 600; font-size: 14px;
            opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 300;
        }
    </style>
</head>
<body>

    <header>
        <div class="brand"><i class="fas fa-brain"></i> FinMind<span>iOS</span></div>
        <div class="live-dot"></div>
    </header>

    <div class="toast" id="toast">System Online</div>

    <main>
        <!-- VIEW 1: TRADE INPUT -->
        <div id="view-trade" class="view-section active">
            <h1 style="font-size: 32px; margin-bottom: 20px;">Analysis</h1>
            
            <div class="input-card">
                <label>Stock Symbol</label>
                <input type="text" id="ticker" value="AAPL" placeholder="Symbol (e.g. AAPL, RELIANCE.NS)">
                
                <label>Strategy</label>
                <select id="mode">
                    <option value="INTRADAY">âš¡ Intraday (Day Trade)</option>
                    <option value="LONG_TERM">ðŸ“… Long Term (Invest)</option>
                </select>

                <button class="btn-main" onclick="startAnalysis()">Run AI Analysis</button>
            </div>

            <div class="input-card">
                <label>Market Scanner</label>
                <p style="color: #666; font-size: 13px; margin-top: 0;">Find opportunities from global news.</p>
                <button class="btn-main btn-scan" onclick="runScanner()">Scan Markets</button>
            </div>
        </div>

        <!-- VIEW 2: CHART -->
        <div id="view-chart" class="view-section" style="padding: 0;">
            <div class="chart-header-overlay">
                <div class="symbol-title" id="display-ticker">--</div>
                <div class="price-display" id="display-price">--</div>
            </div>
            <div id="chart-container"></div>
        </div>

        <!-- VIEW 3: AI REPORT -->
        <div id="view-report" class="view-section">
            <h1 style="font-size: 28px; margin-bottom: 20px;">AI Verdict</h1>
            <div id="ai-content">
                <div style="text-align: center; color: #555; margin-top: 50px;">
                    <i class="fas fa-robot" style="font-size: 40px; margin-bottom: 20px;"></i>
                    <p>No analysis yet.<br>Go to the <b>Trade</b> tab to start.</p>
                </div>
            </div>
        </div>
    </main>

    <!-- BOTTOM NAV -->
    <nav class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('trade', event)">
            <i class="fas fa-sliders-h"></i>
            <span>Trade</span>
        </button>
        <button class="tab-btn" onclick="switchTab('chart', event)">
            <i class="fas fa-chart-line"></i>
            <span>Chart</span>
        </button>
        <button class="tab-btn" onclick="switchTab('report', event)">
            <i class="fas fa-file-alt"></i>
            <span>Report</span>
        </button>
    </nav>

    <!-- LOADING OVERLAY -->
    <div class="loader-modal" id="loader">
        <div class="spinner"></div>
        <p style="margin-top: 20px; font-weight: 600; color: white;">AI Processing...</p>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        // CONFIG
        const KEYS = {
            GEMINI: "AIzaSyCpkdU-h2IUs9OuzvuA0rN7lPSO_EyBZQs",
            FINNHUB: "d65sgn9r01qiish0u6ugd65sgn9r01qiish0u6v0"
        };

        // --- CHART INIT ---
        const chartEl = document.getElementById('chart-container');
        let chart;
        let candleSeries;
        
        try {
            chart = LightweightCharts.createChart(chartEl, {
                layout: { background: { color: '#000000' }, textColor: '#8E8E93' },
                grid: { vertLines: { color: '#1C1C1E' }, horzLines: { color: '#1C1C1E' } },
                crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                rightPriceScale: { borderColor: '#2C2C2E', visible: true },
                timeScale: { borderColor: '#2C2C2E', visible: true },
                handleScroll: { mouseWheel: true, pressedMouseMove: true, horzTouchDrag: true, vertTouchDrag: false }
            });

            candleSeries = chart.addCandlestickSeries({
                upColor: '#30D158', downColor: '#FF453A',
                borderVisible: false, wickUpColor: '#30D158', wickDownColor: '#FF453A'
            });

            new ResizeObserver(entries => {
                if (entries.length === 0 || entries[0].target !== chartEl) return;
                const newRect = entries[0].contentRect;
                chart.applyOptions({ height: newRect.height, width: newRect.width });
            }).observe(chartEl);
        } catch(e) { console.error("Chart Init Error", e); }


        // --- UI UTILS ---
        window.switchTab = function(tabName, event) {
            // Button State
            if(event) {
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                event.currentTarget.classList.add('active');
            } else {
                // Programmatic switch
                const btns = document.querySelectorAll('.tab-btn');
                btns.forEach(b => b.classList.remove('active'));
                if(tabName === 'trade') btns[0].classList.add('active');
                if(tabName === 'chart') btns[1].classList.add('active');
                if(tabName === 'report') btns[2].classList.add('active');
            }

            // View State
            document.querySelectorAll('.view-section').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(`view-${tabName}`).classList.add('active');

            if (tabName === 'chart' && chart) {
                chart.timeScale().fitContent();
            }
        }

        // --- MAIN FUNCTIONS ---
        // Attaching to window to ensure global scope access from HTML
        window.startAnalysis = async function() {
            const tickerInput = document.getElementById('ticker');
            const ticker = tickerInput.value.toUpperCase().trim();
            const mode = document.getElementById('mode').value;
            const loader = document.getElementById('loader');

            // Close keyboard
            tickerInput.blur();

            if (!ticker) return alert("Please enter a stock symbol");

            loader.style.display = 'flex';
            
            try {
                // 1. Fetch Quote
                const qRes = await fetch(`https://finnhub.io/api/v1/quote?symbol=${ticker}&token=${KEYS.FINNHUB}`);
                const qData = await qRes.json();
                
                if (qData.c === 0 && qData.d === null) throw new Error("Invalid Symbol or No Data");

                const price = qData.c;
                const change = qData.d;

                // Update Chart Headers
                document.getElementById('display-ticker').innerText = ticker;
                const pEl = document.getElementById('display-price');
                pEl.innerText = price.toFixed(2);
                pEl.style.color = change >= 0 ? '#30D158' : '#FF453A';

                // 2. Fetch Candle Data
                let rsi = 50;
                let trend = "Neutral";
                try {
                    const now = Math.floor(Date.now() / 1000);
                    const past = now - (200 * 86400); // 200 days
                    const cRes = await fetch(`https://finnhub.io/api/v1/stock/candle?symbol=${ticker}&resolution=D&from=${past}&to=${now}&token=${KEYS.FINNHUB}`);
                    const cData = await cRes.json();

                    if (cData.s === 'ok') {
                        const chartData = cData.t.map((t, i) => ({
                            time: t, open: cData.o[i], high: cData.h[i], low: cData.l[i], close: cData.c[i]
                        }));
                        candleSeries.setData(chartData);
                        
                        const closes = cData.c;
                        rsi = calculateRSI(closes);
                        const sma50 = closes.slice(-50).reduce((a,b)=>a+b,0)/50;
                        trend = price > sma50 ? "Bullish (>50MA)" : "Bearish (<50MA)";
                    }
                } catch (e) { console.warn("Chart fetch error (likely free tier limit)", e); }

                // 3. News
                let news = "No recent specific news.";
                try {
                    const nRes = await fetch(`https://finnhub.io/api/v1/company-news?symbol=${ticker}&from=${new Date(Date.now()-7*86400000).toISOString().split('T')[0]}&to=${new Date().toISOString().split('T')[0]}&token=${KEYS.FINNHUB}`);
                    const nData = await nRes.json();
                    if(nData && nData.length > 0) {
                        news = nData.slice(0, 5).map(n => `- ${n.headline}`).join('\n');
                    }
                } catch(e) { console.warn("News error"); }

                // 4. AI
                const genAI = new GoogleGenerativeAI(KEYS.GEMINI);
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
                
                const prompt = `
                    Act as an expert trader. Analyze ${ticker} (${mode}).
                    Data: Price ${price}, RSI ${rsi.toFixed(1)}, Trend ${trend}.
                    News: ${news}
                    
                    Required Output HTML:
                    1. Verdict: <div class="verdict-banner v-buy">BUY</div> (or v-sell/v-wait)
                    2. Analysis: <div class="ai-text">...bullet points...</div>
                `;

                const result = await model.generateContent(prompt);
                const text = await result.response.text(); // FIXED LINE
                
                document.getElementById('ai-content').innerHTML = text;

                // Auto-switch to Report
                window.switchTab('report');

            } catch (err) {
                alert("System Error: " + err.message);
            } finally {
                loader.style.display = 'none';
            }
        };

        window.runScanner = async function() {
            const loader = document.getElementById('loader');
            loader.style.display = 'flex';
            try {
                const res = await fetch(`https://finnhub.io/api/v1/news?category=general&token=${KEYS.FINNHUB}`);
                const data = await res.json();
                const headlines = data.slice(0, 10).map(n => n.headline).join('. ');

                const genAI = new GoogleGenerativeAI(KEYS.GEMINI);
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
                const result = await model.generateContent(`Scan these headlines: "${headlines}". Pick 3 volatile stocks/sectors. Return as HTML list <ul><li>...`);
                
                const text = await result.response.text(); // FIXED LINE
                document.getElementById('ai-content').innerHTML = `<h2 style="margin-bottom:20px;">Market Scan</h2><div class="ai-text">${text}</div>`;
                
                window.switchTab('report');

            } catch(e) { alert(e.message); }
            finally { loader.style.display = 'none'; }
        }

        function calculateRSI(prices) {
            if (!prices || prices.length < 15) return 50;
            let gains = 0, losses = 0;
            for(let i=1; i<=14; i++) {
                let d = prices[i] - prices[i-1];
                if(d>0) gains+=d; else losses-=d;
            }
            let ag = gains/14, al = losses/14;
            for(let i=15; i<prices.length; i++) {
                let d = prices[i] - prices[i-1];
                if(d>0) { ag=(ag*13+d)/14; al=(al*13)/14; }
                else { ag=(ag*13)/14; al=(al*13-d)/14; }
            }
            return al===0 ? 100 : 100-(100/(1+(ag/al)));
        }

        // System Ready Toast
        setTimeout(() => {
            const t = document.getElementById('toast');
            t.style.opacity = '1';
            setTimeout(() => t.style.opacity = '0', 2000);
        }, 500);

    </script>
</body>
</html>


