<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FinMind Sniper Pro</title>

<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
body {
background: linear-gradient(180deg,#0f0f0f,#000000);
color: white;
font-family: -apple-system, BlinkMacSystemFont;
}
.glass {
background: rgba(255,255,255,0.05);
backdrop-filter: blur(25px);
border: 1px solid rgba(255,255,255,0.08);
}
.fade {
animation: fadeIn 0.4s ease-in-out;
}
@keyframes fadeIn {
from {opacity:0; transform:translateY(10px);}
to {opacity:1; transform:translateY(0);}
}
</style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">

const { useState, useRef, useEffect } = React;

function App(){

const [apiKey,setApiKey] = useState("");
const [capital,setCapital] = useState(100000);
const [status,setStatus] = useState("IDLE");
const [stocks,setStocks] = useState([]);
const [error,setError] = useState("");
const [cooldown,setCooldown] = useState(0);
const [rawOutput,setRawOutput] = useState("");

const controllerRef = useRef(null);

useEffect(()=>{
if(cooldown>0){
const t = setTimeout(()=>setCooldown(cooldown-1),1000);
return ()=>clearTimeout(t);
}
},[cooldown]);

function computeConfidence(d){
let score = 0;
if(d.volumeSpike>150) score+=30;
if(d.rsi>=55 && d.rsi<=70) score+=20;
if(d.breakout) score+=25;
if(d.newsRecent) score+=25;
return score;
}

function positionSize(entry,stop){
const risk = capital * 0.01;
const diff = Math.abs(entry-stop);
if(diff===0) return 0;
return Math.floor(risk/diff);
}

async function scan(){

if(!apiKey) return setError("Enter API Key");
if(cooldown>0) return;

setError("");
setStocks([]);
setRawOutput("");
setStatus("SCANNING");
setCooldown(30);

if(controllerRef.current) controllerRef.current.abort();
controllerRef.current = new AbortController();

const prompt = `
Return STRICT JSON ONLY.

{
"stocks":[
{
"name":"",
"price":number,
"rsi":number,
"volumeSpike":number,
"breakout":true/false,
"newsRecent":true/false,
"target":number,
"stopLoss":number,
"action":"BUY or SHORT"
}
]
}

Scan NSE market right now and return exactly 5 strongest intraday breakout stocks.
`;

try{

const res = await fetch(
`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`,
{
method:"POST",
headers:{"Content-Type":"application/json"},
signal: controllerRef.current.signal,
body: JSON.stringify({
contents:[{parts:[{text:prompt}]}],
tools:[{google_search:{}}]
})
}
);

const data = await res.json();
let text = data.candidates?.[0]?.content?.parts?.[0]?.text;

if(!text){
setError("Empty AI response");
setStatus("IDLE");
return;
}

setRawOutput(text);

// CLEAN MARKDOWN
text = text.replace(/```json/gi,"").replace(/```/g,"").trim();

// EXTRACT JSON BLOCK
const match = text.match(/\{[\s\S]*\}/);

if(!match){
setError("AI returned non-JSON response");
setStatus("IDLE");
return;
}

let parsed;

try {
parsed = JSON.parse(match[0]);
} catch(e){
setError("AI JSON malformed");
setStatus("IDLE");
return;
}

if(!parsed.stocks || !Array.isArray(parsed.stocks)){
setError("Invalid AI structure");
setStatus("IDLE");
return;
}

let valid = [];

parsed.stocks.forEach(s=>{
if(!s.name || !s.price || !s.target || !s.stopLoss) return;

const confidence = computeConfidence(s);

if(confidence>=70){
valid.push({
...s,
confidence,
quantity: positionSize(s.price,s.stopLoss)
});
}
});

if(valid.length===0){
setError("No high-confidence trades found");
setStatus("IDLE");
return;
}

valid.sort((a,b)=>b.confidence-a.confidence);

setStocks(valid.slice(0,5));
setStatus("IDLE");

}catch(e){
setError("System error");
setStatus("ERROR");
}

}

return(
<div className="p-6 space-y-6 max-w-xl mx-auto">

<h1 className="text-2xl font-semibold">
FinMind Sniper Pro
</h1>

<div className="glass p-5 rounded-2xl space-y-4">

<input
type="password"
placeholder="Gemini API Key"
className="w-full bg-transparent outline-none text-sm"
value={apiKey}
onChange={e=>setApiKey(e.target.value)}
/>

<input
type="number"
placeholder="Capital"
className="w-full bg-transparent outline-none text-sm"
value={capital}
onChange={e=>setCapital(Number(e.target.value))}
/>

<button
onClick={scan}
disabled={status==="SCANNING" || cooldown>0}
className="w-full bg-orange-500 text-black font-semibold py-3 rounded-xl"
>
{status==="SCANNING" ? "Scanning..." : cooldown>0 ? `Wait ${cooldown}s` : "Scan Market"}
</button>

</div>

{error && (
<div className="text-red-400 fade">{error}</div>
)}

{stocks.map((s,i)=>(
<div key={i} className="glass p-4 rounded-2xl fade space-y-1">
<div className="flex justify-between">
<span className="font-semibold">{s.name}</span>
<span className="text-orange-400">{s.confidence}%</span>
</div>
<div>Price: {s.price}</div>
<div>Action: {s.action}</div>
<div>Target: {s.target}</div>
<div>Stop: {s.stopLoss}</div>
<div>Qty: {s.quantity}</div>
</div>
))}

{rawOutput && (
<div className="glass p-3 rounded-xl text-xs opacity-50">
RAW AI OUTPUT (Debug):
<br/>
{rawOutput}
</div>
)}

</div>
);
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);

</script>
</body>
</html>
